<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Attack Calculator</title>
<script type="text/javascript">
var tbl;
var tbdy;
var editMode=false;
var localStorage=window.localStorage;
function loadTable(name="") {
	if(localStorage.length == 0) {
		tableCreate();
		return;
	}
	var loadObj={time:0};
	if(name=="") {
		for(var i=0; i<localStorage.length; i++) {
			var key = localStorage.key(i);
			var value = localStorage[key];
			var obj = JSON.parse(value);
			if(obj.time > loadObj.time) {
				loadObj=obj;
			}
		}
	} else {
		loadObj=JSON.parse(localStorage.getItem(name));
	}
	unserialize(loadObj);
}
function unserialize(obj) {
	tbl=document.getElementById('bonusTable');
	tbl.innerHTML=obj.html;
	tbdy=tbl.tBodies[0];
	header=document.getElementById('titleHeader');
	header.innerHTML=obj.title;
	if(editMode){ toggleEditMode(true); }
}
function saveTable(name="") {
	if(name=="") {
		name=document.getElementById('titleHeader').textContent;
	}
	localStorage.setItem(name, JSON.stringify(serialize()));
}
function serialize() {
	var oldMode = editMode;
	if(oldMode) { toggleEditMode(false); }
	tbl=document.getElementById('bonusTable');
	header=document.getElementById('titleHeader');
	var loadObj={time:Date.now(), title:header.innerHTML, html:tbl.innerHTML};
	if(oldMode) { toggleEditMode(true); }
	return loadObj;
}
function copyPaste() {
	var text = JSON.stringify(serialize());
	var out=prompt("Copy/Paste",text);
	if(out!= null) {
		try {
			obj=JSON.parse(out);
			unserialize(obj);
		} catch { ; }
	}
}
function tableCreate() {
	document.getElementById('editCheckbox').checked=false;
	tbl=document.getElementById('bonusTable');
	tbdy=document.createElement('tbody');
	tbl.appendChild(tbdy);

	//Make headings
	makeBlankRow(['', 'Attack', 'Damage', 'Critical Damage', 'Enabled'], 'Header')
	makeBlankRow(['Total', '', '', '', ''], 'totalRow');
	
	makeRow('base attack', 1, 0, 0);
	makeRow('Power Attack', -1, 2, 4);
	makeRow('Strength', 3, 3, 6);
	makeRow('+1 Longsword', 1, "1d8+1", "2d8+2");
	makeRow('Holy', 0, '2d6','2d6');
	//makeRow('', 0, 0,0);

	update();
}
function makeBlankRow(arr, id) {
	var tr=document.createElement('tr');
	tr.id=id;
	var td;

	var i;
	for(i=0;i<arr.length;i++) {
		td=document.createElement('td');
		td.appendChild(document.createTextNode(arr[i]));
		tr.appendChild(td);
	}
	tbdy.appendChild(tr);
	return tr;
}
function makeRow(name, att, dmg, cdmg) {
	if(typeof cdmg === 'undefined'){
		cdmg = 2*dmg;
	}
	var tr=document.createElement('tr');
	var td;

	td=document.createElement('td');
	td.appendChild(document.createTextNode(name));
	tr.appendChild(td);

	td=document.createElement('td');
	td.appendChild(document.createTextNode(att));
	tr.appendChild(td);

	td=document.createElement('td');
	td.appendChild(document.createTextNode(dmg));
	tr.appendChild(td);

	td=document.createElement('td');
	td.appendChild(document.createTextNode(cdmg));
	tr.appendChild(td);

	td=document.createElement('td');
	td.appendChild(document.createTextNode('ON'));
	tr.appendChild(td);

	tr.className="enabled datarow";
	tr.setAttribute("onclick", "javascript:toggle(this);");
	
	if(editMode)
		setRowEditable(tr);

	totalRow = document.getElementById('totalRow');
	tbdy.insertBefore(tr,totalRow);
}
function deleteRow(e) {
	e.parentNode.remove();
}
function toggle(row) {
	var list = row.classList;
	if(list.contains("disabled")) {
		list.remove("disabled")
		list.add("enabled")
		row.lastChild.firstChild.data='ON';
	} else {
		list.remove("enabled")
		list.add("disabled")
		row.lastChild.firstChild.data='OFF';
	}
	update();
}
function update() {
	//update
	var i;
	var totAtt=0;
	var totDmg='';
	var totCDmg='';
	for(row of document.getElementsByClassName("enabled")) {
		totAtt += parseInt(row.childNodes[1].firstChild.data);
		totDmg = addDamage(totDmg,row.childNodes[2].firstChild.data);
		totCDmg = addDamage(totCDmg,row.childNodes[3].firstChild.data);
	}
	row = document.getElementById('totalRow');
	if(totAtt >0) totAtt = "+"+totAtt;
	row.childNodes[1].firstChild.data = totAtt;
	row.childNodes[2].firstChild.data = renderDamage(totDmg);
	row.childNodes[3].firstChild.data = renderDamage(totCDmg);
}
function addDamage(a,b) {
	if(typeof a == 'string') {
		a = parseDamage(a);
	}
	if(typeof b == 'string') {
		b = parseDamage(b);
	}
	var i;

	Object.keys(b).forEach(function(key) {
			if(!(key in a)) {
				a[key]  = b[key];
			} else {
				a[key] += b[key];
			}
		});
	return a;
}
function parseDamage(a) {
	var sum=[];
	splitRegex=/^([0-9]+)([^0-9].*)?$/
	if(a == '') {
		a=0;
	}
	if(isFinite(a)) {
		sum['d0']=parseInt(a);
	} else {
		var res = a.split('+');
		var n;
		var x;
		for(i=0;i<res.length;i++) {
			sp=res[i].match(splitRegex);
			if(!sp) {
				continue;
			}
			x=parseInt(sp[1]);
			if(sp[2]) {
				key=sp[2];
			} else {
				key='d0';
			}
			if(!( key in sum)) {
				sum[key]=0;
			}
			sum[key]+=x;
		}
	}
	return sum;
}
function renderDamage(arr) {
	var interm=[];
	Object.keys(arr).forEach(function(key) {
		interm.push({"key":key, "val":arr[key]});
		});

	reg=/^((?:d[0-9]+)?)([^[0-9].*)?$/
	nod=/^d*/
	interm.sort(function(a,b) {
		var m1=a.key.match(reg);
		var m2=b.key.match(reg);
		if(m1[2]==m2[2]) {
			return m2[1].replace(nod,"")-m1[1].replace(nod,"");
		}
		if(m1[2]==undefined) {
			return -1;
		}
		if(m2[2]==undefined) {
			return 1;
		}
		return m1[2].localeCompare(m2[2]);
	});

	var result='';

	interm.forEach(function(obj) {
			if(result != '') {
				result += '+';
			}
			if(obj.key == 'd0') {
				result += obj.val
			} else {
				result += obj.val+""+obj.key;
			}
		});
	if(result == '')
		return "0"
	return result;
}
function calcAvgDmg(arr) {
	if(typeof arr == 'string') {
		arr = parseDamage(arr);
	}
	var i;
	var total=0;
	if(arr[0]) {
		total+=arr[0];
	}
	for(i=1;i<arr.length;i++) {
		if(arr[i]) {
			total+= arr[i]*(i+1)/2.0;
		}
	}
	return total;
}
function noEnter(e) {
	return e.which != 13
}
function toggleEditMode(mode) {
	if(mode) {
		editMode=true;
		for(row of document.getElementsByClassName("toEdit")) {
			row.setAttribute("contenteditable", true);
			row.addEventListener("input", update,false);
			row.addEventListener("keydown",noEnter);
		}
		for(row of document.getElementsByClassName("datarow")) {
			setRowEditable(row);
		}
		for(row of document.getElementsByClassName("editOnly")) {
			row.style.display="inline";
		}
	} else {
		editMode=false;
		for(row of document.getElementsByClassName("toEdit")) {
			row.removeAttribute("contenteditable");
			row.removeEventListener("input", update);
			row.removeEventListener("keydown", noEnter);
		}
		for(row of document.getElementsByClassName("datarow")) {
			removeRowEditable(row);
		}
		for(row of document.getElementsByClassName("editOnly")) {
			row.style.display="none";
		}
	}
}
function setRowEditable(row) {
	row.setAttribute("contenteditable", true);
	row.addEventListener("input", update,false);
	row.addEventListener("keydown",noEnter);
	row.setAttribute("onclick", "");

	td=document.createElement('td');
	//td.appendChild(document.createTextNode('\u1F5D1'));
	td.appendChild(document.createTextNode('\u2718'));
	td.setAttribute("onclick", "javascript:deleteRow(this)", false);
	row.appendChild(td);
}
function removeRowEditable(row) {
	row.removeAttribute("contenteditable");
	row.removeEventListener("input", update);
	row.removeEventListener("keydown", noEnter);
	row.setAttribute("onclick", "javascript:toggle(this);");

	row.lastChild.remove();
}
</script>
<style>
.enabled {
	background: lightgreen;
}
.disabled {
	background: red;
}
</style>
</head>
<body onload="loadTable()">
<center>
	<div style="width: 30em; height: 2em" align=left>
		<input type="checkbox" id="editCheckbox" onClick="javascript:toggleEditMode(this.checked)" /> Edit
		<input type="button" class="editOnly" id="newRowButton" onClick="javascript:makeRow('New Row', 0,0,0)" value="New Row" style="display:none" />
		<input type="button" class="editOnly" onClick="javascript:saveTable()" value="Save" style="display:none" />
		<input type="button" class="editOnly" onClick="javascript:loadTable()" value="Load" style="display:none" />
		<input type="button" class="editOnly" onClick="javascript:copyPaste()" value="Import/Export" style="display:none" />
	</div>
<h1 id="titleHeader" class="toEdit">Attack Table: Example Character, level 1</h1>

<table id="bonusTable"></table>
</center>

</body>
