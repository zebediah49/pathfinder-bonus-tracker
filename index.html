<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Attack Calculator</title>
<script type="text/javascript">
var tbl;
var tbdy;
var editMode=false;
function tableCreate() {
	document.getElementById('editCheckbox').checked=false;
	tbl=document.getElementById('bonusTable');
	tbdy=document.createElement('tbody');
	tbl.appendChild(tbdy);

	count=1;
	//Make headings
	makeBlankRow(['', 'Attack', 'Damage', 'Critical Damage', 'Enabled'], 'Header')
	
	makeRow('base attack', 8, 0);
	makeRow('Strength', 0, 1);
	makeRow('Dexterity', 4, 0);
	makeRow('MW Longbow', 1, '1d8','3d8');
	makeRow('+1 Longbow', 1, '1d8+1','3d8+3');
	makeRow('Point Blank Shot', 1, 1);
	makeRow('Deadly Aim', -3, 6);
	makeRow('Rapid Shot', -2, 0);
	makeRow('Arcane Strike', 0, 2);
	makeRow('Bardic Performance', 2, 2);
	makeRow('Haste', 1, 0);
	makeRow('Smite Evil', 9, 8);
	makeRow('Smite Evil [1st strike]', 0, 8);
	makeRow('Bane', 2, '2d6+2','2d6+6');
	//makeRow('', 0, 0,0);

	makeBlankRow(['Total', '', '', '', ''], 'totalRow');

	for(ti=5;ti<14;ti++) {
		toggle(ti);
	}
=======
	//Make headings
	makeBlankRow(['', 'Attack', 'Damage', 'Critical Damage', 'Enabled'], 'Header')
	makeBlankRow(['Total', '', '', '', ''], 'totalRow');
	
	makeRow('base attack', 1, 0, 0);
	makeRow('Power Attack', -1, 2, 4);
	makeRow('Strength', 3, 3, 6);
	makeRow('+1 Longsword', 1, "1d8+1", "2d8+2");
	makeRow('Holy', 0, '2d6','2d6');
	//makeRow('', 0, 0,0);

	update();
>>>>>>> refs/rewritten/master
}
function makeBlankRow(arr, id) {
	var tr=document.createElement('tr');
	tr.id=id;
	var td;

	var i;
	for(i=0;i<arr.length;i++) {
		td=document.createElement('td');
		td.appendChild(document.createTextNode(arr[i]));
		tr.appendChild(td);
	}
	tbdy.appendChild(tr);
<<<<<<< HEAD
}
function makeRow(name, att, dmg, cdmg) {
	if(typeof cdmg === 'undefined'){
		cdmg = 3*dmg;
	}
	var tr=document.createElement('tr');
	var td;

	td=document.createElement('td');
	td.appendChild(document.createTextNode(name));
	tr.appendChild(td);

	td=document.createElement('td');
	td.appendChild(document.createTextNode(att));
	tr.appendChild(td);

	td=document.createElement('td');
	td.appendChild(document.createTextNode(dmg));
	tr.appendChild(td);

	td=document.createElement('td');
	td.appendChild(document.createTextNode(cdmg));
	tr.appendChild(td);

	td=document.createElement('td');
	td.appendChild(document.createTextNode('ON'));
	tr.appendChild(td);

	enabled[count]=true;
	tr.setAttribute("onclick", "javascript:toggle("+count+");");
	tr.style.background='lightgreen';

	tbdy.appendChild(tr);
	count++;
}
function toggle(num) {
	var row = tbdy.childNodes[num];
	enabled[num] = !enabled[num];
	if(enabled[num]) {
		row.style.background='LightGreen';
		row.lastChild.firstChild.data='ON';
	} else {
		row.style.background='red';
		row.lastChild.firstChild.data='OFF';
	}
	var i;
	//update
	var totAtt=0;
	var totDmg='';
	var totCDmg='';
	for(i=1;i<count;i++) {
		if(enabled[i]) {
			row = tbdy.childNodes[i];
			totAtt += parseInt(row.childNodes[1].firstChild.data);
			totDmg = addDamage(totDmg,row.childNodes[2].firstChild.data);
			totCDmg = addDamage(totCDmg,row.childNodes[3].firstChild.data);
		}
	}
	row = document.getElementById('totalRow');
	row.childNodes[1].firstChild.data = '+'+totAtt;
=======
	return tr;
}
function makeRow(name, att, dmg, cdmg) {
	if(typeof cdmg === 'undefined'){
		cdmg = 2*dmg;
	}
	var tr=document.createElement('tr');
	var td;

	td=document.createElement('td');
	td.appendChild(document.createTextNode(name));
	tr.appendChild(td);

	td=document.createElement('td');
	td.appendChild(document.createTextNode(att));
	tr.appendChild(td);

	td=document.createElement('td');
	td.appendChild(document.createTextNode(dmg));
	tr.appendChild(td);

	td=document.createElement('td');
	td.appendChild(document.createTextNode(cdmg));
	tr.appendChild(td);

	td=document.createElement('td');
	td.appendChild(document.createTextNode('ON'));
	tr.appendChild(td);

	tr.className="enabled datarow";
	tr.setAttribute("onclick", "javascript:toggle(this);");
	
	if(editMode)
		setRowEditable(tr);

	totalRow = document.getElementById('totalRow');
	tbdy.insertBefore(tr,totalRow);
}
function deleteRow(e) {
	e.parentNode.remove();
}
function toggle(row) {
	var list = row.classList;
	if(list.contains("disabled")) {
		list.remove("disabled")
		list.add("enabled")
		row.lastChild.firstChild.data='ON';
	} else {
		list.remove("enabled")
		list.add("disabled")
		row.lastChild.firstChild.data='OFF';
	}
	update();
}
function update() {
	//update
	var i;
	var totAtt=0;
	var totDmg='';
	var totCDmg='';
	for(row of document.getElementsByClassName("enabled")) {
		totAtt += parseInt(row.childNodes[1].firstChild.data);
		totDmg = addDamage(totDmg,row.childNodes[2].firstChild.data);
		totCDmg = addDamage(totCDmg,row.childNodes[3].firstChild.data);
	}
	row = document.getElementById('totalRow');
	if(totAtt >0) totAtt = "+"+totAtt;
	row.childNodes[1].firstChild.data = totAtt;
>>>>>>> refs/rewritten/master
	row.childNodes[2].firstChild.data = totDmg;
	row.childNodes[3].firstChild.data = totCDmg;
}
function addDamage(a,b) {
	var i;

	var sum = parseDamage(a);
	var resB = parseDamage(b);
	for(i=0;i<resB.length;i++) {
		if(resB[i]) {
			if(!( i in sum)) {
				sum[i]=resB[i];
			} else {
				sum[i] += resB[i];
			}
		}
	}

	var result='';
	for(i=sum.length;i>0;i--) {
		if(sum[i] && sum[i] != 0) {
			if(result != '') {
				result += '+';
			}
			result += sum[i]+"d"+i;
		}
	}
	if(sum[0]) {
		if(result) {
			result += '+';
		}
		result += sum[0];
	}
<<<<<<< HEAD
=======
	if(result == '')
		return "0"
>>>>>>> refs/rewritten/master
	return result;
}
function parseDamage(a) {
	var sum=[];
	if(a == '') {
		a=0;
	}
	if(isFinite(a)) {
		sum[0]=parseInt(a);
	} else {
		var res = a.split('+');
		var n;
		var x;
		for(i=0;i<res.length;i++) {
			if(isFinite(res[i])) {
				n=0;
				x=parseInt(res[i]);
			} else {
				sp = res[i].split('d');
				n=parseInt(sp[1]);
				x=parseInt(sp[0]);
			}
			if(!( n in sum)) {
				sum[n]=0;
			}
			sum[n]+=x;
		}
	}
	return sum;
}
function calcAvgDmg(arr) {
	if(typeof arr == 'string') {
		arr = parseDamage(arr);
	}
	var i;
	var total=0;
	if(arr[0]) {
		total+=arr[0];
	}
	for(i=1;i<arr.length;i++) {
		if(arr[i]) {
			total+= arr[i]*(i+1)/2.0;
		}
	}
	return total;
}
<<<<<<< HEAD
</script>
</head>
<body onload="tableCreate()">
<center>
<h1>Attack Table: Example level 8 paladin archer</h1>
=======
function noEnter(e) {
	return e.which != 13
}
function toggleEditMode(mode) {
	if(mode) {
		editMode=true;
		for(row of document.getElementsByClassName("toEdit")) {
			row.setAttribute("contenteditable", true);
			row.addEventListener("input", update,false);
			row.addEventListener("keydown",noEnter);
		}
		for(row of document.getElementsByClassName("datarow")) {
			setRowEditable(row);
		}
		document.getElementById("newRowButton").style.display="inline";
	} else {
		editMode=false;
		for(row of document.getElementsByClassName("toEdit")) {
			row.removeAttribute("contenteditable");
			row.removeEventListener("input", update);
			row.removeEventListener("keydown", noEnter);
		}
		for(row of document.getElementsByClassName("datarow")) {
			removeRowEditable(row);
		}
		document.getElementById("newRowButton").style.display="none";
	}
}
function setRowEditable(row) {
	row.setAttribute("contenteditable", true);
	row.addEventListener("input", update,false);
	row.addEventListener("keydown",noEnter);
	row.setAttribute("onclick", "");

	td=document.createElement('td');
	//td.appendChild(document.createTextNode('\u1F5D1'));
	td.appendChild(document.createTextNode('\u2718'));
	td.setAttribute("onclick", "javascript:deleteRow(this)", false);
	row.appendChild(td);
}
function removeRowEditable(row) {
	row.removeAttribute("contenteditable");
	row.removeEventListener("input", update);
	row.removeEventListener("keydown", noEnter);
	row.setAttribute("onclick", "javascript:toggle(this);");

	row.lastChild.remove();
}
</script>
<style>
.enabled {
	background: lightgreen;
}
.disabled {
	background: red;
}
</style>
</head>
<body onload="tableCreate()">
<center>
	<div style="width: 10em; height: 2em" align=left>
		<input type="checkbox" id="editCheckbox" onClick="javascript:toggleEditMode(this.checked)" /> Edit
		<input type="button" id="newRowButton" onClick="javascript:makeRow('New Row', 0,0,0)" value="New Row" style="display:none" />
	</div>
<h1 class="toEdit">Attack Table: Example Character, level 1</h1>
>>>>>>> refs/rewritten/master

<table id="bonusTable"></table>
</center>

</body>
